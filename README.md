# BeautyCRM 云开发版

## 项目简介
BeautyCRM 是基于微信小程序云开发能力构建的美业门店客户关系管理示例项目，提供门店、客户、消费、储值等常见业务场景。项目代码包含小程序前端、云函数与初始化数据集合，可直接导入微信开发者工具体验。

## 本地启动步骤
1. **准备工具**
   - 安装 [微信开发者工具](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)，并登录与云开发环境相同的微信号。
   - 确保已开通微信小程序云开发权限，且拥有可用的云环境 ID。
2. **导入项目**
   - 通过 Git 克隆或下载本仓库。
   - 在微信开发者工具中选择“导入项目”，项目目录指向仓库根目录（包含 `app.js` 的位置）。
   - `appid` 可使用你的测试号或体验号，`project.config.json` 中的 `appid` 仅为示例，如与实际不符可在导入时修改。
3. **初始化云开发**
   - 导入成功后，在开发者工具左侧点击“云开发”。
   - 若是第一次使用，请创建或选择一个云环境，并记下环境 ID，后续部署与数据导入都将使用该环境。

完成以上步骤后，即可在模拟器中运行小程序前端界面。

## 云函数部署流程
1. 打开“云开发”面板，切换到 **云函数** 标签页。
2. 点击“上传并部署” → “上传所有文件” 或逐个选择函数目录（位于仓库 `cloudfunctions/` 下）。
3. 部署时选择与你的项目一致的云环境。
4. 部署完成后，可以在云开发控制台查看每个函数的日志与触发情况，确认是否部署成功。

> **提示**：如函数依赖额外的 npm 包，请在对应函数目录执行 `npm install` 后再部署。本项目示例函数仅返回模拟数据，无额外依赖。

## 数据集合初始化
1. 在云开发面板切换到 **数据库**。
2. 依次创建 `db/` 目录中对应的集合名称。
3. 使用“导入”功能将 `db/*.json` 文件导入到对应集合中。

## 环境（ENV）切换方式
- **代码中指定环境 ID**：在 `app.js` 的 `wx.cloud.init` 中增加 `env` 配置，例如：
  ```js
  wx.cloud.init({
    env: 'your-env-id',
    traceUser: true,
  })
  ```
  将 `your-env-id` 替换为云开发环境 ID。适用于需要在不同环境之间切换或多人协作时显式指定。
- **通过开发者工具切换**：在“云开发”面板右上角可以切换当前使用的环境；当未在代码中显式设置 `env` 时，项目将使用该面板中选定的环境。
- **多环境调试建议**：
  - 为开发、测试、生产分别创建独立环境，命名如 `beautycrm-dev`、`beautycrm-prod`，避免数据互相影响。
  - 在多人协作场景，可使用环境变量文件（如自定义 `env.js`）管理不同环境 ID，并在构建前进行替换或手动切换。

## 常见错误码与排查
| 错误码 | 说明 | 排查与解决建议 |
| :----- | :--- | :------------- |
| `-501000` | 云调用参数或权限异常 | 确认调用的云函数已部署且未删除，检查 `wx.cloud.callFunction` 的 `name` 是否与函数目录一致。|
| `-502005` | 没有访问集合/函数的权限 | 检查云开发控制台中数据库/云函数的权限设置，确保使用的环境与部署环境一致。|
| `-401001` | 云环境未初始化或 ID 错误 | 在 `wx.cloud.init` 中配置正确的 `env`，或在开发者工具中切换到有效的环境。确保已开通云开发并创建环境。|
| `-404011` | 目标集合不存在 | 确认数据库中已创建对应集合，并已从 `db/*.json` 导入初始数据。|
| `-601003` | 云函数执行超时 | 检查云函数逻辑是否存在长时间阻塞，或在函数配置中适当提高超时时间。|

更多错误码可参考官方文档：[微信小程序·云开发错误码说明](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/reference/sdk-api/error-code.html)。

## Markdown 校验与链接
- 本 README 采用标准 Markdown 语法编写，标题层级从 `#` 开始逐级递进。
- 所有外部链接均指向微信官方文档，确保可访问性与内容准确性。

## 目录结构速览
```
├── app.js / app.wxss                 # 小程序入口与全局样式
├── pages/                            # 业务页面
├── cloudfunctions/                   # 云函数集合
├── db/                               # 示例数据集合导入文件
├── services/ & utils/                # 前端调用封装
└── project.config.json               # 项目配置
```

欢迎根据业务需求继续扩展功能，如需提交生产环境请检查真实接口与安全策略。
